name: Deploy to Server

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Auto Deploy Laravel
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_SECRET }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy ke server
        run: |
          ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            echo "ðŸš€ ========================================="
            echo "ðŸš€ Mulai deployment nih..."
            echo "ðŸš€ ========================================="
            echo ""
            
            # Masuk ke direktori project
            echo "ðŸ“ Masuk ke direktori project..."
            cd /var/www/uangku || exit 1
            echo "âœ… Sudah di direktori project"
            echo ""
            
            # Pull latest code (kalau pakai git)
            # echo "ðŸ“¥ Pull latest code dari repository..."
            # git pull origin master || exit 1
            # echo "âœ… Code terbaru sudah di-pull"
            # echo ""
            
            # Install/update dependencies
            # echo "ðŸ“¦ Install/update dependencies..."
            # composer install --no-dev --optimize-autoloader || exit 1
            # echo "âœ… Dependencies sudah terinstall"
            # echo ""
            
            # Run artisan commands
            echo "ðŸ”„ ========================================="
            echo "ðŸ”„ Running Artisan Commands..."
            echo "ðŸ”„ ========================================="
            echo ""
            
            echo "ðŸ“Š Running migrations..."
            php artisan migrate --force || exit 1
            echo "âœ… Migrations selesai!"
            echo ""
            
            echo "âš¡ Optimizing application..."
            php artisan optimize || exit 1
            echo "âœ… Application sudah di-optimize!"
            echo ""
            
            echo "ðŸ§¹ Clearing cache..."
            php artisan cache:clear || exit 1
            echo "âœ… Cache sudah dibersihkan!"
            echo ""
            
            echo "ðŸ”§ Clearing config cache..."
            php artisan config:clear || exit 1
            echo "âœ… Config cache sudah dibersihkan!"
            echo ""
            
            echo "ðŸ“± Setting Telegram webhook..."
            php artisan telegram:set-webhook || exit 1
            echo "âœ… Telegram webhook sudah di-set!"
            echo ""
            
            echo "ðŸŽ‰ ========================================="
            echo "ðŸŽ‰ Deployment selesai! Semua lancar! ðŸŽ‰"
            echo "ðŸŽ‰ ========================================="
          ENDSSH

